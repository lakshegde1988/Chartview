from flask import Flask, jsonify, request
import yfinance as yf
import os
import csv

app = Flask(__name__)

# Load stock symbols from CSV
def load_stock_symbols():
    stock_symbols = []
    csv_path = os.path.join(os.path.dirname(__file__), '../data/stocks.csv')
    with open(csv_path, mode='r') as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            stock_symbols.append(row['symbol'])
    return stock_symbols

@app.route('/')
def home():
    stock_symbols = load_stock_symbols()
    return jsonify(stock_symbols=stock_symbols)

@app.route('/get_ohlc')
def get_ohlc():
    symbol = request.args.get('symbol', 'RELIANCE')
    nse_symbol = f"{symbol}.NS"

    try:
        data = yf.download(nse_symbol, period="1mo", interval="1d")
        if data.empty:
            return jsonify({"error": "No data found for this symbol"}), 404

        ohlc_data = []
        for date, row in data.iterrows():
            ohlc_data.append({
                "time": int(date.timestamp() * 1000),
                "open": row['Open'],
                "high": row['High'],
                "low": row['Low'],
                "close": row['Close']
            })

        return jsonify(ohlc_data)
    except Exception as e:
        print(f"Error: {str(e)}")
        return jsonify({"error": "Internal Server Error", "message": str(e)}), 500

# Vercel looks for an 'app' callable
if __name__ == '__main__':
    app.run()
